# 12. `Start temporary, End temporary`

前面在讲子査询的时候说过,[查询优化器会优先尝试将`IN`子查询转换成半连接](https://github.com/rayallen20/howDoesMySQLWork/blob/main/%E7%AC%AC14%E7%AB%A0%20%E5%9F%BA%E4%BA%8E%E8%A7%84%E5%88%99%E7%9A%84%E4%BC%98%E5%8C%96(%E5%86%85%E5%90%AB%E5%AD%90%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E4%BA%8C%E4%B8%89%E4%BA%8B)/3.%20%E5%AD%90%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/2.%20%E5%AD%90%E6%9F%A5%E8%AF%A2%E5%9C%A8MySQL%E4%B8%AD%E6%98%AF%E6%80%8E%E4%B9%88%E6%89%A7%E8%A1%8C%E7%9A%84/3.%20IN%E5%AD%90%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/3.%20%E5%B0%86%E5%AD%90%E6%9F%A5%E8%AF%A2%E8%BD%AC%E6%8D%A2%E4%B8%BA%E5%8D%8A%E8%BF%9E%E6%8E%A5/1.%20%E5%89%8D%E8%A8%80.md),
而半连接又有好多种执行策略.当执行策略为[`Duplicate Weed-out`](https://github.com/rayallen20/howDoesMySQLWork/blob/main/%E7%AC%AC14%E7%AB%A0%20%E5%9F%BA%E4%BA%8E%E8%A7%84%E5%88%99%E7%9A%84%E4%BC%98%E5%8C%96(%E5%86%85%E5%90%AB%E5%AD%90%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E4%BA%8C%E4%B8%89%E4%BA%8B)/3.%20%E5%AD%90%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/2.%20%E5%AD%90%E6%9F%A5%E8%AF%A2%E5%9C%A8MySQL%E4%B8%AD%E6%98%AF%E6%80%8E%E4%B9%88%E6%89%A7%E8%A1%8C%E7%9A%84/3.%20IN%E5%AD%90%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/3.%20%E5%B0%86%E5%AD%90%E6%9F%A5%E8%AF%A2%E8%BD%AC%E6%8D%A2%E4%B8%BA%E5%8D%8A%E8%BF%9E%E6%8E%A5/3.%20Duplicate%20Weed-out(%E9%87%8D%E5%A4%8D%E5%80%BC%E6%B6%88%E9%99%A4).md)时,
也就是通过建立临时表来为外层查询中的记录进行去重操作时:

- 驱动表查询执行计划的`Extra`列将显示`Start temporary`提示
- 被驱动表査询执行计划的`Extra`列将显示`End temporary`提示

例如(这里加了hint,我猜测和成本计算有关):

```
mysql> EXPLAIN
    -> SELECT /*+ SEMIJOIN(@subq1 DUPSWEEDOUT)
    ->           NO_SEMIJOIN(@subq1 FIRSTMATCH, LOOSESCAN, MATERIALIZATION) */
    ->        *
    -> FROM single_table AS s
    -> WHERE s.key1 IN (
    ->   SELECT /*+ QB_NAME(subq1) */ t.key3
    ->   FROM single_table2 AS t
    ->   WHERE t.common_field = 'a'
    -> );
+----+-------------+-------+------------+------+---------------+----------+---------+------------------------+------+----------+------------------------------+
| id | select_type | table | partitions | type | possible_keys | key      | key_len | ref                    | rows | filtered | Extra                        |
+----+-------------+-------+------------+------+---------------+----------+---------+------------------------+------+----------+------------------------------+
|  1 | SIMPLE      | t     | NULL       | ALL  | idx_key3      | NULL     | NULL    | NULL                   | 9942 |    10.00 | Using where; Start temporary |
|  1 | SIMPLE      | s     | NULL       | ref  | idx_key1      | idx_key1 | 403     | charset_demo_db.t.key3 |    1 |   100.00 | End temporary                |
+----+-------------+-------+------------+------+---------------+----------+---------+------------------------+------+----------+------------------------------+
2 rows in set, 2 warnings (0.00 sec)
```

注: 这里若不使用hint,则子查询会被物化:

```
mysql> EXPLAIN SELECT * FROM single_table WHERE key1 IN (SELECT key3 FROM single_table2 WHERE common_field = 'a');
+----+--------------+---------------+------------+------+---------------+----------+---------+------------------+------+----------+-------------+
| id | select_type  | table         | partitions | type | possible_keys | key      | key_len | ref              | rows | filtered | Extra       |
+----+--------------+---------------+------------+------+---------------+----------+---------+------------------+------+----------+-------------+
|  1 | SIMPLE       | <subquery2>   | NULL       | ALL  | NULL          | NULL     | NULL    | NULL             | NULL |   100.00 | Using where |
|  1 | SIMPLE       | single_table  | NULL       | ref  | idx_key1      | idx_key1 | 403     | <subquery2>.key3 |    1 |   100.00 | NULL        |
|  2 | MATERIALIZED | single_table2 | NULL       | ALL  | idx_key3      | NULL     | NULL    | NULL             | 9942 |    10.00 | Using where |
+----+--------------+---------------+------------+------+---------------+----------+---------+------------------+------+----------+-------------+
3 rows in set, 1 warning (0.00 sec)
```
