# 1. 简单LRU链表存在的问题

这个简单的LRU链表存在一些问题,因为存在以下2种情况:

- 情况1: 预读(read ahead)

    前面说过,只有当用到某个页时,才会将其从磁盘加载到`Buffer Pool`中.所谓预读,就是InnoDB认为执行当前的请求时,
    可能会在后面读取某些页面,就预先把这些页面加载到`Buffer Pool`中.根据触发方式不同,预读又可以细分为以下2种:

    - 线性预读(Linear Read Ahead,也叫顺序预读)

        当顺序访问的某个区(extent)的页面数量超过系统变量`innodb_read_ahead_threshold`定义的值时,会触发一次异步请求,
        该请求用于**异步**读取下一个区中全部的页面到`Buffer Pool`中.注意**异步**读取意味着从磁盘中加载这些被预读的页面时,
        并不会影响到当前工作线程的正常执行.
        
        **系统变量`innodb_read_ahead_threshold`的作用域为GLOBAL级别**,其默认值为56.可以在服务器启动时通过启动选项来调整该值,
        或者服务器运行过程中直接调整该系统变量的值.

        ```
        mysql> SHOW VARIABLES LIKE 'innodb_read_ahead_threshold';
        +-----------------------------+-------+
        | Variable_name               | Value |
        +-----------------------------+-------+
        | innodb_read_ahead_threshold | 56    |
        +-----------------------------+-------+
        1 row in set (0.00 sec)
        ```

        注意该变量的作用域为GLOBAL级别,需要使用`SET GLOBAL`命令来修改该变量的值.

  - 随机预读(Random Read Ahead)

      若某个区的13个连续的页面都被加载到了`Buffer Pool`中,无论这些页面是否顺序读取,都会触发一次异步请求,
      该请求用于读取本区中所有其他页面到`Buffer Pool`中.系统变量`innodb_random_read_ahead`用于控制是否开启随机预读功能.
      该变量的作用域为GLOBAL级别,默认值为`OFF`,表示InnoDB不会默认开启随机预读功能.
      若想开启该功能,通过修改启动参数或使用`SET GLOBAL`命令把该变量的值设置为`ON`即可.

预读本来是个好事,若预读到`Buffer Pool`中的页被成功使用到,则可以极大的提高语句执行的效率.可如果用不到,
则这些预读的页都会放到LRU链表的头部.若此时`Buffer Pool`的容量不太大,且很多预读的页面都没有用到,这就会导致位于LRU链表尾部的
一些缓冲页会很快被淘汰掉,会大大降低缓存命中率(有点"劣币驱逐良币"的意思).

- 情况2: 全表扫描

    全表扫描意味着要访问该表的聚簇索引的所有叶子节点对应的页(当然,扫描叶子节点时,首先要从B+树中定位到第1个叶子节点的地1条记录,
    这个过程中还要访问一些非叶子节点).若需要访问的页面特别多,且`Buffer Pool`又不能全部容纳这些页面,就需要将其他语句在执行过程
    中用到的页面"排挤"出`Buffer Pool`.
    
    之后在其他查询语句重新执行时,又要重新将这些语句用到的页从磁盘加载到`Buffer Pool`中(这
    就像你在一个饭店吃饭吃着好好的,突然来了一群人把你从饭店里赶出去,等他们吃完了之后,你又重新回到这个饭店点菜吃一样).
    
    在业务中一般不会对很大的表执行全表扫描操作,因为这是一个很耗时的操作,只有在特定场景下偶尔对很大的表执行全表扫描操作.由于对很大的表
    执行全表扫描操作可能要把`Buffer Pool`中的缓冲页全换一次,这会严重影响到其他查询对`Buffer Pool`的使用,从而降低`Buffer Pool`的命中率.

总结一下可能降低`Buffer Pool`的两种情况:

- 加载到`Buffer Pool`中的页不一定被用到
- 若有非常多的使用频率偏低的页被同时加载到`Buffer Pool`中,则可能会把那些使用频率非常高的页从`Buffer Pool`中淘汰掉
