# 3. 记录头信息中的`1byte_offs_flag`的值是怎么选择的

![REDUNDANT行格式示意图](./img/REDUNDANT行格式示意图.jpg)

- 字段长度偏移列表存储的偏移量,其实是每个列的值占用的空间,在记录的真实数据处结束的位置

拿`record_format_demo`第1条记录为例:

- `0x06`代表第一个列(`row_id`)在记录的真实数据第6个字节处结束
- `0x0C`代表第二个列(`trx_id`)在记录的真实数据第12个字节处结束
- `0x13`代表第三个列(`roll_ptr`)在记录的真实数据第19个字节处结束
- 以此类推
- 最后一个列(`c4`)对应的偏移量值为`0x25`,也就意味着最后一个列在记录的真实数据第37个字节处结束
  - 也就意味着整条记录的真实数据部分实际上占用了37个字节

在字段长度偏移列表中,每个列对应的偏移量可以占用1个字节或者2个字节来存储,那到底什么时候用1个字节,什么时候用2个字节呢?
其实是根据该条REDUNDANT行格式中,记录的真实数据部分占用的总大小来判断的:

- 当记录的真实数据部分占用的字节数不大于127(十六进制`0x7F`,二进制`01111111`)时,每个列对应的偏移量占用1个字节
  - 如果整个记录的真实数据部分占用的存储空间都不大于127个字节,那么每个列对应的偏移量值肯定也就不大于127,自然就可以使用1个字节来表示
- 当记录的真实数据部分占用的字节数大于127,但不大于32767(十六进制`0x7FFF`,二进制`0111111111111111`)时,每个列对应的偏移量占用2个字节
- 当记录的真实数据部分占用的字节数大于32767时,记录的一部分已经存放到了所谓的溢出页中,在本页只保留前768个字节和20字节的溢出页面地址(当然这20个字节中还记录了一些别的信息)
  - 这种情况下,因为字段长度偏移列表处记录的是**每个列在本页面中的偏移**,所以每个列使用2个字节来存储偏移量还是足够用的

可以看出,REDUNDANT行格式比较简单粗暴,直接使用整个记录的真实数据长度来决定使用1个字节还是2个字节存储列对应的偏移量.
只要整条记录的真实数据占用的存储空间大小大于127,即使某个列的值占用存储空间不大于127,也同样需要使用2个字节来表示该列对应的偏移量.
简单粗暴,所以这种行格式有些过时了

为了在解析记录时知道每个列的偏移量是使用1个字节还是2个字节表示的,REDUNDANT行格式特意在记录头信息里放置了一个名为`1byte_offs_flag`的属性:

- 当它的值为1时,表明使用1个字节存储
- 当它的值为0时,表明使用2个字节存储

注: 1个字节能表示的范围是0-255,那么为什么在记录的真实数据占用的存储空间大于127(而非大于255)时,就采用2个字节表示各个列的偏移量呢?
