# 4. 增删改操作对二级索引的影响

1个表可以拥有1个聚簇索引和多个二级索引,前面讲的都是增删改操作对聚簇索引记录所做的影响.对于二级索引记录来说,
`INSERT`/`DELETE`操作和在聚簇索引中执行时产生的影响差不多,但是`UPDATE`操作稍微不太一样.若`UPDATE`语句中,
没有涉及二级索引的列,比如:

```sql
UPDATE undo_demo
SET co1 ='手枪'
WHERE id =2;
```

则不需要对二级索引执行任何操作.

反之,若在`UPDATE`语句中,涉及到二级索引的列,比如:

```sql
UPDATE undo demo
SET
    key1='P92',
    col ='手枪' 
WHERE id=2;
```

因为该语句涉及了`key1`列,而`key1`列又包含在二级索引`idx_key1`中,所以这相当于更新了二级索引的键值.更新二级索引记录的键值,
就要进行下面这2个操作:

- 对旧的二级索引记录执行`delete mark`操作
  - 注意:是`delete mark`操作,而不是彻底将这条二级索引记录删除,这主要是考虑到后面的内容要讲MVCC
- 根据更新后的值创建一条新的二级索引记录,然后在二级索引对应的B+树中重新定位到它的位置,并插入进去

注: 其实逻辑上和"在聚簇索引中更改主键值"的操作是类似的,都是先标记删除旧记录,然后插入新记录.

注意: 虽然只有聚簇索引记录才有`trx_id`/`roll_pointer`这些属性(也就是说只有通过聚簇索引才能找到`undo`日志,或者说`undo`日志只用于聚簇索引),但是每当增删改一条二级索引记录时,都会影响该条二级索引记录所在
页面的[`Page Header`部分](https://github.com/rayallen20/howDoesMySQLWork/blob/main/%E7%AC%AC5%E7%AB%A0%20%E7%9B%9B%E6%94%BE%E8%AE%B0%E5%BD%95%E7%9A%84%E5%A4%A7%E7%9B%92%E5%AD%90--InnoDB%E6%95%B0%E6%8D%AE%E9%A1%B5%E7%BB%93%E6%9E%84/5.%20Page%20Header(%E9%A1%B5%E9%9D%A2%E5%A4%B4%E9%83%A8).md)中一个名为`PAGE_MAX_TRX_ID`的属性.该属性表示修改当前页的最大的事务id.记住这个属性,后面会用到.
