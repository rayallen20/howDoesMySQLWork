# 0. 前言

为实现事务的原子性,InnoDB存储引擎**在实际进行记录的增/删/改操作时,都需要先把对应的`undo`日志记下来**(WAL机制).
**一般每对一条记录进行1次改动,就对应着1条`undo`日志**.但在某些更新记录的操作中,可能会对应着2条`undo`日志,这个会在后面讲到.
1个事务在执行过程中可能新增/删除/更新若干条记录,也就是说需要记录很多条对应的`undo`日志.这些`undo`日志从0,开始编号,也就是说根据
生成的顺序分别称为:

- 第0号undo日志
- 第1号undo日志
- 第n号undo日志

这个编号被称为`undo no`.

简单理解: `undo no`表示1个事务内,修改的第几条记录(但是也不是精确的,因为有些更新操作,可能更新1条数据会对应2条`undo`日志).编号从0开始计数.

这些`undo`日志被记录到类型为[`FIL_PAGE_UNDO_LOG`]()(对应的十六进制为`0x0002`)的页面中.这些页面可以从系统表空间中分配,
也可以从一种专门存放`undo`日志的表空间(这种表空间名为`undo tablespace`)中分配.关于如何分配存储`undo`日志的页面稍后再说.
先看不同操作都会产生什么样子的`undo`日志.为了故事的顺利发展,先创建一个名为`undo_demo`的表:

```
mysql> CREATE TABLE undo_demo (
    ->     id INT NOT NULL,
    ->     key1 VARCHAR(100),
    ->     col VARCHAR(100),
    ->     PRIMARY KEY (id),
    ->     KEY idx_key1 (key1)
    -> )Engine=InnoDB CHARSET=utf8mb4;
Query OK, 0 rows affected (0.03 sec)
```

该表中有3个列,其中:

- `id`列是主键
- `key1`列为二级索引列
- `col`列是普通的列

前面讲[InnoDB的数据字典](https://github.com/rayallen20/howDoesMySQLWork/blob/main/%E7%AC%AC9%E7%AB%A0%20%E5%AD%98%E6%94%BE%E9%A1%B5%E9%9D%A2%E7%9A%84%E5%A4%A7%E6%B1%A0%E5%AD%90--InnoDB%E7%9A%84%E8%A1%A8%E7%A9%BA%E9%97%B4/3.%20%E7%B3%BB%E7%BB%9F%E8%A1%A8%E7%A9%BA%E9%97%B4/1.%20%E7%B3%BB%E7%BB%9F%E8%A1%A8%E7%A9%BA%E9%97%B4%E7%9A%84%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84/1.%20InnoDB%E6%95%B0%E6%8D%AE%E5%AD%97%E5%85%B8/1.%20SYS_TABLES%E8%A1%A8.md)时讲到过:每个表都会被分配一个唯一的`table id`.
可通过系统数据库`information_schema`中的`innodb_sys_tables`表(MySQL8.X中,该表为`INNODB_TABLES`)来查看某个表对应的`table id`:

```
mysql> SELECT * FROM information_schema.INNODB_TABLES WHERE name='join_demo/undo_demo';
+----------+---------------------+------+--------+-------+------------+---------------+------------+--------------+--------------------+
| TABLE_ID | NAME                | FLAG | N_COLS | SPACE | ROW_FORMAT | ZIP_PAGE_SIZE | SPACE_TYPE | INSTANT_COLS | TOTAL_ROW_VERSIONS |
+----------+---------------------+------+--------+-------+------------+---------------+------------+--------------+--------------------+
|     1183 | join_demo/undo_demo |   33 |      6 |    27 | Dynamic    |             0 | Single     |            0 |                  0 |
+----------+---------------------+------+--------+-------+------------+---------------+------------+--------------+--------------------+
1 row in set (0.00 sec)
```

从查询结果可知,`undo_demo`表对应的`table id`为1183,先把这个值记住,我们后边有用.

注: 此处书中的`table id`为138,所以后续的一些图示中,`table id`会显示为138.
