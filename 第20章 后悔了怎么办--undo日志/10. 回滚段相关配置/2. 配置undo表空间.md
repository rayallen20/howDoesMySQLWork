# 2. 配置`undo`表空间

默认情况下,针对普通表设立的回滚段(第0号回滚段和第33-127号回滚段)都是被分配到系统表空间中的.其中第0号回滚段是一直在系统表空间,
但是第33-127号回滚段可以通过配置放到自定义的undo表空间中.但是该配置只能在系统初始化(创建数据目录时)时使用,一旦初始化完成,就不能再次更改了.
相关系统变量如下:

- 系统变量`innodb_undo_directory`:用于指定undo表空间所在的目录,若系统初始化时未指定,则默认undo表空间所在的目录就是数据目录

    ```
    mysql> SHOW VARIABLES LIKE 'innodb_undo_directory';
    +-----------------------+-------+
    | Variable_name         | Value |
    +-----------------------+-------+
    | innodb_undo_directory | ./    |
    +-----------------------+-------+
    1 row in set (0.00 sec)
    ```
    
    该变量作用域为`GLOBAL`级别.

    ```
    root@mysql-master:/var/lib/mysql# ll /var/lib/mysql
    total 108136
    ...
    -rw-r-----  1 mysql mysql 16777216 Aug 29 12:14  undo_001
    -rw-r-----  1 mysql mysql 16777216 Aug 29 12:14  undo_002
    ```

    可以看到,`undo`日志默认存储到了数据目录下.

- 系统变量`innodb_undo_tablespaces`: 用于指定undo表空间的数量.该参数的默认值为0,表示不创建任何`undo`表空间

    注: 该变量在MySQL8.0.14起默认值为2,表示创建2个undo表空间.

    ```
    mysql> SHOW VARIABLES LIKE 'innodb_undo_tablespaces';
    +-------------------------+-------+
    | Variable_name           | Value |
    +-------------------------+-------+
    | innodb_undo_tablespaces | 2     |
    +-------------------------+-------+
    1 row in set (0.01 sec)
    ```
  
    其实上面的`undo_001`和`undo_002`就是这2个undo表空间对应的文件.

    第33-127号回滚段可以平均分布到不同的undo表空间中.

    注: 若在系统初始化的时候指定了创建了undo表空间,则系统表空间中的第0号回滚段将处于不可用状态

比如: 在系统初始化时指定:

- 系统变量`innodb_rollback_segments`的值为35
- 系统变量`innodb_undo_tablespaces`的值为2

这就会将第33/34号回滚段,分别分布到1个undo表空间中.

设立undo表空间的一个好处就是: 在undo表空间中的文件大到一定程度时,可以自动的将该undo表空间截断(truncate)成一个小文件.
而系统表空间的大小只能不断的增大,不能截断.
