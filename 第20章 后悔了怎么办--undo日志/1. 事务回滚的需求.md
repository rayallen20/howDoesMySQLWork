# 1. 事务回滚的需求

我们说过,事务需要保证原子性,即:事务中的操作要么全部完成,要么什么也不做.但有时候在事务执行到一部分时,会出现一些情况,比如:

- 事务执行过程中可能遇到各种错误,比如:
  - 服务器本身的错误
  - 操作系统错误
  - 突然断电导致的错误

- 程序员可以在事务执行过程中手动输入`ROLLBACK`语句结束当前的事务的执行

这两种情况都会导致事务执行到一部分就结束,但是事务在执行过程中可能已经修改了很多东西,为保证事务的原子性,
需要把事务修改的这些东西改回原来的的样子,这个过程就称为回滚(rollback).这就造成了一个假象:这个事务看起来什么都没做(其实是修改了之后又修改回原来的样子了,
这样从结果上来看是没有修改过的),所以符合原子性要求(有时仅需对部分语句进行回滚,有时需要对整个事务进行回滚).

数据库中的回滚和下棋时的悔棋差不多:

- 插入一条记录,回滚对应的操作就是把这条记录删除掉
- 更新一条记录,回滚对应的操作就是把该记录更新为旧值
- 删除一条记录,回滚对应的操作就是把该记录再插回去

说的貌似很简单的样子.

从上面的描述中已经能隐约感觉到,每当要对一条记录做改动时(这里的改动可以指`INSERT`/`DELETE`/`UPDATE`),都需要留一手:把回滚时所需的东西都记下来.
比如:

- 在插入一条记录时,至少要把这条记录的主键值记下来,之后回滚时只需要把该主键值对应的记录删掉即可
- 在删除一条记录时,至少要把这条记录中的内容都记下来,之后回滚时再把由这些内容组成的记录插入到表中即可
- 在修改一条记录时,至少要把被更新的列的旧值都记下来,之后回滚时再把这些列更新为旧值即可

数据库的设计者把这些为了回滚而记录的东西称为**撤销日志**(undo log),也称为`undo`日志.

简单理解,`undo`日志负责将事务的修改操作"撤销"(有点像`Command + Z`),事务提交之后的事情`undo`日志就不负责了(类比于一个文件保存之后,就不能再撤销保存之前的操作了).

注意: 由于查询操作(`SELECT`)并不会修改任何用户记录,所以在执行查询操作时,并不需要记录相应的`undo`日志.
在真实的InnoDB 中,`undo`日志其实并不像上面说的那么简单,不同类型的操作产生的`undo`日志的格式也是不同的.
这里先来看一下事务id的概念.
