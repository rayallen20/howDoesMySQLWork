# 11. `undo`日志在崩溃恢复时的作用

上一章讲到,在服务器因为崩溃恢复的过程中,首先需要按照`redo`日志将各个页面的数据恢复到崩溃之前的状态,这样可以保证已经提交的事务的持久性.
但是这里仍然存在一个问题:那些没有提交的事务写的`redo`日志可能也已经刷盘,这些未提交的事务修改过的页面,在MySQL服务器重启时,可能也被恢复了.

为保证事务的原子性,需要在服务器重启时将这些未提交的事务回滚掉.如何找到这些未提交的事务呢?这个工作需要`undo`日志来完成.

可以通过系统表空间的第5号页面(类型为`TRX_SYS`的页面)定位到128个回滚段的位置,在每1个回滚段的1024个`undo slot`中,
找到那些值不为`FIL_NULL`的`undo slot`,每1个`undo slot`对应着1个`Undo`页面链表.

然后从`Undo`页面链表`first undo page`的`Undo Log Segment Header`中找到`TRX_UNDO_STATE`属性,
该属性标识当前`Undo`页面链表所处的状态.

若该属性的值为`TRX_UNDO_ACTIVE`,则意味着有一个活跃的事务正在向该`Undo`页面链表中写入`undo`日志.

然后再在`Undo Log Segment Header`中找到`TRX_UNDO_LAST_LOG`属性,通过该属性可以找到本`Undo`页面链表中的最后一个`Undo Log Header`的位置.

从该`Undo Log Header`中可以找到对应的事务id以及一些其他信息,则该事务id对应的事务就是未提交的事务.

原因: 在崩溃恢复时,若`Undo`页面链表`first undo page`的`Undo Log Segment Header`中的`TRX_UNDO_STATE`属性值为`TRX_UNDO_ACTIVE`,
就证明该事务在崩溃点尚未提交,因此需要在恢复中回滚该事务.通过`Undo Log Header`中的`TRX_UNDO_TRX_ID`,就可以找到这个要被回滚的事务id了.

通过`undo`日志中记录的信息,将该事务对页面所做的更改全部回滚掉,这样就保证了事务的原子性.
