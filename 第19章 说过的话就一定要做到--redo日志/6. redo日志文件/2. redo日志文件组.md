# 2. `redo`日志文件组

MySQL的数据目录(使用`SHOW VARIABLES LIKE 'datadir'`查看)下,默认有2个名为`ib_logfile0`和`ib_logfile1`的文件,
`log buffer`中的日志默认情况下就是刷新到这2个磁盘文件中.

注: 从MySQL8.0.30开始,InnoDB的`redo`日志文件命名和存放位置发生了变化:

- 默认目录: 在数据目录下的子目录`#innodb_redo`中
- 文件命名方式: 文件名不再是`ib_logfile0`/`ib_logfile1`,而是类似`redo_001`/`redo_002`的命名方式.

```
root@mysql-master:/var/lib/mysql/#innodb_redo# ll /var/lib/mysql/#innodb_redo/
total 102408
drwxr-x---  2 mysql mysql    4096 Aug 21 10:23  ./
drwx------ 11 mysql mysql    4096 Aug 21 10:18  ../
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:20 '#ib_redo17'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo18_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo19_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo20_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo21_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo22_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo23_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo24_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo25_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo26_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo27_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo28_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo29_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo30_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo31_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo32_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo33_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo34_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo35_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo36_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo37_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo38_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo39_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo40_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo41_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo42_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo43_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo44_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo45_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo46_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo47_tmp'
-rw-r-----  1 mysql mysql 3276800 Aug 21 10:18 '#ib_redo48_tmp'
```

其中,以`_tmp`结尾的文件,表示预分配的`redo`日志文件,在 MySQL8.0.30+的新`redo`日志实现中:

- 第一次启动服务或调整`redo`参数(比如`innodb_redo_log_capacity`)时,InnoDB会预分配一批`redo`文件
- 这些文件先以`_tmp`后缀形式存在,表示它们是预留的日志段,还没有进入循环使用
- 当`redo`日志循环到需要扩展/切换时,`_tmp`文件会"转正",变成无`_tmp`后缀的正式文件

以`_tmp`结尾的文件是InnoDB提前创建好的备用文件,目的是为了防止以后需要扩展时再动态分配(这样可以减少运行时I/O抖动)

所以在我的环境中,现在只有`#ib_redo17`被用作活跃的`redo`文件.

若要默认的`redo`日志文件相关配置,可以通过以下几个启动参数来调节:

- `innodb_log_group_home_dir`: 该参数指定了`redo`日志文件所在的目录,默认值为当前的数据目录,作用域为`GLOBAL`级别

    ```
    mysql> SHOW VARIABLES LIKE 'innodb_log_group_home_dir';
    +---------------------------+-------+
    | Variable_name             | Value |
    +---------------------------+-------+
    | innodb_log_group_home_dir | ./    |
    +---------------------------+-------+
    1 row in set (0.05 sec)
    ```

- `innodb_log_file_size`: 该参数指定了每个`redo`日志文件的大小,默认值为`50331648`字节(约48MB),作用域为`GLOBAL`级别

    ```
    mysql> SHOW VARIABLES LIKE 'innodb_log_file_size';
    +----------------------+----------+
    | Variable_name        | Value    |
    +----------------------+----------+
    | innodb_log_file_size | 50331648 |
    +----------------------+----------+
    1 row in set (0.01 sec)
    ```
    
    注: 在MySQL8.0.30+中,`innodb_log_file_size`已废弃,仅为了兼容而保留,但不再实际控制文件大小.在MySQL8.0.30+中,
    `redo`日志的大小由系统变量`innodb_log_files_in_group`决定(`innodb_redo_log_capacity`已废弃)

- `innodb_log_files_in_group`: 该参数指定`redo`日志文件的个数,默认值为2,最大值为100.

    ```
    mysql> SHOW VARIABLES LIKE 'innodb_log_files_in_group';
    +---------------------------+-------+
    | Variable_name             | Value |
    +---------------------------+-------+
    | innodb_log_files_in_group | 2     |
    +---------------------------+-------+
    1 row in set (0.01 sec)
    ```
    
    注: 在MySQL8.0.30+中,`innodb_log_files_in_group`变成了废弃参数,只保留在`SHOW VARIABLES`中做兼容.
    实际上InnoDB强制使用32个segment文件来管理`redo`日志.

- `innodb_redo_log_capacity`: 该参数指定`redo`日志的总容量,默认值为`104857600`字节(约100MB),作用域为`GLOBAL`级别

    ```
    mysql> SHOW VARIABLES LIKE 'innodb_redo_log_capacity';
    +--------------------------+-----------+
    | Variable_name            | Value     |
    +--------------------------+-----------+
    | innodb_redo_log_capacity | 104857600 |
    +--------------------------+-----------+
    1 row in set (0.00 sec)
    ```
    
    即: 每个`redo`日志文件的大小 = `innodb_redo_log_capacity / 32` = 3.125MB.

后续还是按照MySQL5.X版本的配置来讲解,因为MySQL8.0.30+的`redo`日志实现我也完全不懂,只能是按书上的来.

从以上描述中可知,磁盘上的`redo`日志文件不止一个,而是以一个**日志文件组**的形式出现的.这些文件以`ib_logfile[数字]`(数字可以是0/1/2...)
的形式进行命名.在将`redo`日志写入日志文件组时:

- 从`ib_logfile0`开始写
- 若`ib_logfile0`写满了,则接着向`ib_logfile1`中写
- 同理,`ib_logfile1`写满了就向`ib_logfile2`中写
- 依此类推

若写到最后一个文件,则重新转到`ib_logfile0`继续写,整个过程如下图示:

![redo日志文件组示意图](./img/redo日志文件组示意图.jpg)

在MySQL5.X中,`redo`日志文件总大小为: `innodb_log_file_size * innodb_log_files_in_group`.

注: 采用**循环使用**的方式向`redo`日志文件组中写数据,是有可能出现"追尾",即:后写入的`redo`日志覆盖掉前面写的`redo`日志的情况的.
所以InnoDB的设计者提出了checkpoint的概念,后续会讲到.
