# 3. 定期更新统计数据

MySQL的设计者提供了如下2种更新统计数据的方式:

- 开启`innodb_stats_auto_recalc`

    系统变量`innodb_stats_auto_recalc`决定了服务器是否自动重新计算统计数据.它的默认值是ON,也就是该功能默认是开启的.
    每个表都维护了1个变量,该变量记录着对该表进行增删改的记录条数.若发生变动的记录数量超过了表大小的10%,
    且自动重新计算统计数据的功能是打开的,那么服务器会重新计算1次统计数据,并且更新`innodb_table_stats`和`innodb_index_stats`表,
    重新计算统计数据后该变量的值重置为0.不过**自动重新计算统计数据的过程是异步发生的**,
    也就是说,即使表中变动的记录数超过了10%,可能也不会立即自动重新计算统计数据,因为存在一定的延迟.

    ```
    mysql> SHOW VARIABLES LIKE 'innodb_stats_auto_recalc';
    +--------------------------+-------+
    | Variable_name            | Value |
    +--------------------------+-------+
    | innodb_stats_auto_recalc | ON    |
    +--------------------------+-------+
    1 row in set (0.00 sec)
    ```
    
    再一次强调,**InnoDB默认以表为单位来收集和存储统计数据**.因此,可以单独为某个表设置是否自动重新计算统计数的属性,
    设置方式就是在创建或修改表的时候通过指定`STATS_AUTO_RECALC`属性来指明是否为该表自动重新计算统计数据:
    
    ```
    CREATE TABLE 表名 (...) Engine=InnoDB, STATS_AUTO_RECALC = (1|0);
    ```
    
    ```
    ALTER TABLE 表名 Engine=InnoDB, STATS_AUTO_RECALC = (1|0);
    ```

    - 当`STATS_AUTO_RECALC = 1`时,表明想让该表自动重新计算统计数据
    - 当`STATS_AUTO_RECALC = 0`时,表明不想让该表自动重新计算统计数据

    若在创建表时未指定`STATS_AUTO_RECALC`属性,则默认采用系统变量`innodb_stats_auto_recalc`的值作为该属性的值.

- 手动调用`ANALYZE TABLE`语句来更新统计信息

    也可以手动调用`ANALYZE TABLE`语句来重新计算统计数据.例如下面的语句可以用于更新`single_table`表的统计数据:
    
    ```
    mysql> ANALYZE TABLE single_table;
    +------------------------------+---------+----------+----------+
    | Table                        | Op      | Msg_type | Msg_text |
    +------------------------------+---------+----------+----------+
    | charset_demo_db.single_table | analyze | status   | OK       |
    +------------------------------+---------+----------+----------+
    1 row in set (0.16 sec)
    ```
    
    注意: **`ANALYZE TABLE`语句会立即重新计算统计数据,也就是这个过程是同步的**.在表中索引多或者采样页面特别多时,
    这个过程可能会特别慢.
