# 1. `n_rows`统计项的收集

InnoDB在统计1个表中有多少行记录时,过程大致如下:

- step1. 按照一定算法(并不是纯粹随机的)从聚簇索引中选取几个叶子节点页面
- step2. 统计每个页面中包含的记录数量
- step3. 计算1个页面中平均包含的记录数量
- step4. 用`1个页面中平均包含的记录数量 * 全部叶子节点的数量`

即为该表的`n_rows`值.

注: 真实的计算过程比上面描述的稍微复杂一些,不过大致上就是这样的

可以看出,这个`n_rows`值精确与否取决于统计时采样的页面数量.
MySQL的设计者提供了一个名为`innodb_stats_persistent_sample_pages`的系统变量.在使用永久性的统计数据时,
该系统变量表示计算统计数据时采样的页面数量.

- 该值设置的越大,统计出的`n_rows`值越精确,但是统计耗时也就越久
- 该值设置的越小,统计出的`n_rows`值越不精确,但是统计耗时越少

所以在实际使用是需要权衡利弊,该系统变量的默认值是20.

```
mysql> SHOW VARIABLES LIKE 'innodb_stats_persistent_sample_pages';
+--------------------------------------+-------+
| Variable_name                        | Value |
+--------------------------------------+-------+
| innodb_stats_persistent_sample_pages | 20    |
+--------------------------------------+-------+
1 row in set (0.00 sec)
```

前边说过,**InnoDB默认是以表为单位来收集和存储统计数据的**.因此可以单独设置某个表的采样页面的数量.
设置方式就是在创建或修改表的时候通过指定`STATS_SAMPLE_PAGES`属性来指明统计该表的信息时使用的采样页面数量:

```
CREATE TABLE 表名 (...) Engine=InnoDB, STATS_SAMPLE_PAGES = 具体的采样页面数量;
```

```
ALTER TABLE 表名 Engine=InnoDB, STATS_SAMPLE_PAGES = 具体的采样页面数量;
```

若在创建表的语句中没有指定`STATS_SAMPLE_PAGES`属性,则默认使用系统变量`innodb_stats_persistent_sample_pages`的值作为该属性的值.
