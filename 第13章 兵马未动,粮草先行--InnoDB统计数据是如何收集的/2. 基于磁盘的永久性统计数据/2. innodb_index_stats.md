# 2. `innodb_index_stats`

`innodb_index_stats`各个列的含义如下:

|        字段名         |       描述        |
|:------------------:|:---------------:|
|  `database_name`   |      数据库名       |
|    `table_name`    |       表名        |
|    `index_name`    |       索引名       |
|   `last_update`    |   本条记录最后更新时间    |
|    `stat_name`     |     统计项的名称      |
|    `stat_value`    |    对应的统计项的值     |
|   `sample_size`    | 为生成统计数据而采样的页面数量 |
| `stat_description` |    对应的统计项的描述    |

注意这个表的主键是`(database_name, table_name, index_name, stat_name)`.其中`stat_name`是指统计项的名称,
也就是说`innodb_index_stats`表的每条记录代表着1个索引的1个统计项.

先来看一下这张表中的数据:

```
mysql> SELECT * FROM mysql.innodb_index_stats WHERE table_name = 'single_table';
+-----------------+--------------+--------------+---------------------+--------------+------------+-------------+-----------------------------------+
| database_name   | table_name   | index_name   | last_update         | stat_name    | stat_value | sample_size | stat_description                  |
+-----------------+--------------+--------------+---------------------+--------------+------------+-------------+-----------------------------------+
| charset_demo_db | single_table | PRIMARY      | 2025-07-31 10:46:17 | n_diff_pfx01 |      10200 |          20 | id                                |
| charset_demo_db | single_table | PRIMARY      | 2025-07-31 10:46:17 | n_leaf_pages |         51 |        NULL | Number of leaf pages in the index |
| charset_demo_db | single_table | PRIMARY      | 2025-07-31 10:46:17 | size         |         97 |        NULL | Number of pages in the index      |
| charset_demo_db | single_table | idx_key1     | 2025-07-31 10:46:17 | n_diff_pfx01 |      10000 |          13 | key1                              |
| charset_demo_db | single_table | idx_key1     | 2025-07-31 10:46:17 | n_diff_pfx02 |      10000 |          13 | key1,id                           |
| charset_demo_db | single_table | idx_key1     | 2025-07-31 10:46:17 | n_leaf_pages |         13 |        NULL | Number of leaf pages in the index |
| charset_demo_db | single_table | idx_key1     | 2025-07-31 10:46:17 | size         |         14 |        NULL | Number of pages in the index      |
| charset_demo_db | single_table | idx_key3     | 2025-07-31 10:46:17 | n_diff_pfx01 |      10000 |          16 | key3                              |
| charset_demo_db | single_table | idx_key3     | 2025-07-31 10:46:17 | n_diff_pfx02 |      10000 |          16 | key3,id                           |
| charset_demo_db | single_table | idx_key3     | 2025-07-31 10:46:17 | n_leaf_pages |         16 |        NULL | Number of leaf pages in the index |
| charset_demo_db | single_table | idx_key3     | 2025-07-31 10:46:17 | size         |         17 |        NULL | Number of pages in the index      |
| charset_demo_db | single_table | idx_key_part | 2025-07-31 10:46:17 | n_diff_pfx01 |      10000 |          32 | key_part1                         |
| charset_demo_db | single_table | idx_key_part | 2025-07-31 10:46:17 | n_diff_pfx02 |      10000 |          32 | key_part1,key_part2               |
| charset_demo_db | single_table | idx_key_part | 2025-07-31 10:46:17 | n_diff_pfx03 |      10000 |          32 | key_part1,key_part2,key_part3     |
| charset_demo_db | single_table | idx_key_part | 2025-07-31 10:46:17 | n_diff_pfx04 |      10000 |          32 | key_part1,key_part2,key_part3,id  |
| charset_demo_db | single_table | idx_key_part | 2025-07-31 10:46:17 | n_leaf_pages |         32 |        NULL | Number of leaf pages in the index |
| charset_demo_db | single_table | idx_key_part | 2025-07-31 10:46:17 | size         |         33 |        NULL | Number of pages in the index      |
| charset_demo_db | single_table | uk_key2      | 2025-07-31 10:46:17 | n_diff_pfx01 |      10000 |          10 | key2                              |
| charset_demo_db | single_table | uk_key2      | 2025-07-31 10:46:17 | n_leaf_pages |         10 |        NULL | Number of leaf pages in the index |
| charset_demo_db | single_table | uk_key2      | 2025-07-31 10:46:17 | size         |         11 |        NULL | Number of pages in the index      |
+-----------------+--------------+--------------+---------------------+--------------+------------+-------------+-----------------------------------+
20 rows in set (0.00 sec)
```

查看这个结果的步骤如下:

- 步骤1. 先查看`index_name`列

这个列说明该记录是哪个索引的统计信息,从结果中可以看出,`PRIMARY`索引(也就是主键)占了3条记录,`idx_key_part`索引占了6条记录

- 步骤2. 针对`index_name`列相同的记录
    - `stat_name`表示针对该索引的统计项名称
    - `stat_value`表示该索引在该统计项上的值
    - `stat_description`用于描述该统计项的含义

    1个索引的统计项如下:

    - `n_leaf_pages`: 表示该索引的叶子节点实际占用的页面数量
    - `size`: 表示该索引共占用的页面数量
        - 包括已经分配给叶子节点segment和非叶子节点segment的,但尚未使用到的页面数量
    - `n_diff_pfxNN`: 表示对应的索引列不重复的值的数量
        - 这里的`NN`表示结果中的`01`/`02`/`03`...
        - 以`idx_key_part`举例:
        - `n_diff_pfx01`表示的是统计`key_part1`这1个列中不重复的值的数量
        - `n_diff_pfx02`表示的是统计`key_part1`/`key_part2`这2个列组合起来后,不重复的值的数量
        - `n_diff_pfx03`表示的是统计`key_part1`/`key_part2`/`key_part3`这3个列组合起来后,不重复的值的数量
        - `n_diff_pfx04`表示的是统计`key_part1`/`key_part2`/`key_part3`/`id`这4个列组合起来后,不重复的值的数量

    注意: 对于普通的二级索引,并不能保证它的索引列值是唯一的.比如对于`idx_key1`来说,`key1`列就可能有很多值重复的记录.
    此时只有在索引列的基础上上加上主键,才可以区分2条索引列值都一样的二级索引记录.
    而对于主键和唯一二级索引则没有这个问题,因为它们本身就可以保证索引列值的是不重复的,所以也不需要再统计一遍在索引列后加上主键值
    的不重复值的数量了.比如结果中的`idx_key1`有`n_diff_pfx01`和`n_diff_pfx02`这2个统计项,而`uk_key2`却只有`n_diff_pfx01`一个统计项

- 步骤3. 在计算某些索引列中包含的不重复值的数量时,需要对一些叶子节点页面进行采样,`sample_size`列就表明了采样的页面数量是多少

注: 对于有多个列的联合索引来说,采样的页面数量是: `innodb_stats_persistent_sample_pages * 索引列的个数`.
当需要采样的页面数量大于该索引的叶子节点数量时,那么所有的叶子节点都需要被采样.
所以在查询结果中看到不同索引对应的`sample_size`列的值可能是不同的.

注: 这里我的`innodb_stats_persistent_sample_pages`的值为20,
但是联合索引`idx_key_part`的`sample_size`列的值为32而不是`20 * 3 = 60`,我不知道这是为什么
