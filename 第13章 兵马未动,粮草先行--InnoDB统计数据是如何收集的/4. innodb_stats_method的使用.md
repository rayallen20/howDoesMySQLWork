# 4. `innodb_stats_method`的使用

索引列不重复的值的数量这个统计数据对于MySQL查询优化器十分重要,因为通过它可以计算出在索引列中平均一个值重复多少行.它的应用场景主要有2个:

- 单表查询中单点扫描区间太多

    例如这个查询:
    
    ```sql
    SELECT *
    FROM tbl_name
    WHERE key IN ('xx1', 'xx2', ..., 'xxn');
    ```
    
    当IN子句对应的单点扫描区间太多时,采用`index dive`的方式直接访问B+树索引,来统计每个单点扫描区间对应的记录的数量就太耗费性能了.
    所以直接依赖统计数据中的平均一个值重复多少行来计算单点扫描区间对应的记录数量.

- 在执行连接查询时
    - 若有涉及两个表的等值匹配连接条件(ON子句)
    - 且该连接条件对应的被驱动表中的列又拥有索引时
    - 则可以使用`ref`访问方法来查询被驱动表

    例如:

    ```sql
    SELECT *
    FROM t1 JOIN t2
    ON t1.column = t2.key
    WHERE ...;
    ```
    
    假设`t2`为被驱动表,在优化器生成执行计划时,查询并没有真正执行.也就是说,在真正执行对`t2`表的查询前,`t1.column`的值是不确定的.
    所以也无法使用`index dive`的方式直接访问`t2.key`对应的B+树索引去统计每个单点扫描区间对应的记录的数量(相当于`t2.key = 常数`时,
    常数的值不确定).这种情况下,只能依赖统计数据中的一个值平均重复多少行来计算单点区间对应的记录数量.

在统计索引列不重复的值的数量时,有个比较棘手的问题是:当索引列中出现NULL值怎么办?例如某个索引列的内容如下:

```
+------+
| col  |
+------+
| 1    |
| 2    |
| NULL |
| NULL |
+------+
```

此时计算这个`col`列中不重复的值的数量时,就存在以下分歧:

- 有人认为NULL值代表一个未确定的,所以MySQL的设计者才认为任何和NULL值做比较的表达式的结果都为NULL,比如:

    ```
    mysql> SELECT 1 = NULL;
    +----------+
    | 1 = NULL |
    +----------+
    |     NULL |
    +----------+
    1 row in set (0.00 sec)
    ```
    
    ```
    mysql> SELECT 1 != NULL;
    +-----------+
    | 1 != NULL |
    +-----------+
    |      NULL |
    +-----------+
    1 row in set (0.00 sec)
    ```
    
    ```
    mysql> SELECT NULL = NULL;
    +-------------+
    | NULL = NULL |
    +-------------+
    |        NULL |
    +-------------+
    1 row in set (0.00 sec)
    ```
    
    ```
    mysql> SELECT NULL != NULL;
    +--------------+
    | NULL != NULL |
    +--------------+
    |         NULL |
    +--------------+
    1 row in set (0.00 sec)
    ```

    这种观点认为每个NULL值都是独一无二的,也就是说统计索引列不重复的值的数量时,应该把NULL值当作一个独立的值,
    所以`col`列的不重复的值的数量就是:4(分别是1/2/NULL/NULL这4个值)

- 有人认为其实NULL值在业务上就是表示"没有",因此所有的NULL值代表的意义是一样的
    - 这种计算方式下,`col`列不重复的值的数量就是:3(分别是1/2/NULL这3个值)

- 有人认为NULL完全没有意义,所以在统计索引列不重复的值的数量时根本就不把它们算进来
    - 这种计算方式下,`col`列不重复的值的数量就是:2(分别是1/2这2个值)

MySQL的设计者提供了一个名为`innodb_stats_method`的系统变量,该变量用于定义在计算某个索引列不重复值的数量时,如何对待NULL值:

- `nulls_equal`: 认为所有NULL值都是相等的
    - 该值是`innodb_stats_method`的默认值
    - 若某个索引列中NULL值特别多,该统计方式会让优化器认为某个列中平均一个值重复次数特别多,所以倾向于不使用索引进行访问

- `nulls_unequal`: 认为所有NULL值都是不相等的
    - 若某个索引列中NULL值特别多,该统计方式会让优化器认为某个列中平均一个值重复次数特别少,所以倾向于使用索引进行访问

- `nulls_ignore`: 直接把NULL值忽略掉

```
mysql> SHOW VARIABLES LIKE 'innodb_stats_method';
+---------------------+-------------+
| Variable_name       | Value       |
+---------------------+-------------+
| innodb_stats_method | nulls_equal |
+---------------------+-------------+
1 row in set (0.00 sec)
```

注: 上述关于系统变量`innodb_stats_method`的知识是在MySQL的文档中体现的,但是当原书作者实际查看MySQL5.7.22的源码时,
他发现情况是这样的:

- 对于基于内存的统计数据来说,`nulls_equal`和`nulls_ignore`的效果是相同的
- 对于基于磁盘的统计数据来说,无论将`innodb_stats_method`设置为什么值,都将该变量的值认为是`nulls_equal`(直接硬编码到代码中的)

原书作者对此也十分迷惑.
