# 5. 写操作

平常所用到的写操作无非是DELETE/UPDATE/INSERT这3种

- DELETE

    对一条记录执行DELETE操作的过程:
    
    - 先在B+树中定位到这条记录的位置
    - 然后获取这条记录的X锁
    - 最后再执行`delete mark`操作
    
    可以把这个"先定位待删除记录在B+树中的位置,然后获取这条记录的X锁的过程"看成是一个获取X锁的锁定读

- UPDATE

    在对一条记录进行UPDATE操作时分为以下3种情况:
    
    - 若未修改该记录的主键值且被更新的列所占用的存储空间在修改前后未发生变化

        则:
    
        - 先在B+树中定位到这条记录的位置
        - 然后再获取记录的X锁
        - 最后在原记录的位置进行修改操作

        其实也可以把这个"先定位待修改记录在B+树中的位置然后再获取记录的X锁的过程"看成是一个获取X锁的锁定读

    - 若未修改该记录的主键值且至少有一个被更新的列占用的存储空间在修改前后发生变化

        则:
    
        - 先在B+树中定位到这条记录的位置
        - 然后获取记录的X锁
        - 之后将该记录彻底删除掉(就是把记录彻底移入垃圾链表)
        - 最后再插入一条新记录

        可以把这个"先定位待修改记录在B+树中的位置,然后再获取记录的X锁的过程"看成是一个获取X锁的锁定读,与被彻底删除的记录关联的锁也会被转移到这条新插入的记录上来.

    - 若修改了该记录的主键值

        则:相当于在原记录上执行DELETE操作之后再来一次INSERT操作,加锁操作就需要按照DELETE和INSERT的规则进行了

- INSERT

    一般情况下,新插入的一条记录受隐式锁保护,不需要在内存中为其生成对应的锁结构.更多关于隐式锁的细节后续会讲到
    
    注: 在一些特殊情况下INSERT操作也会在内存中生成锁结构,后续会讲到

**在一个事务中加的锁一般在事务提交或中止时才会释放**.也有特殊情况,遇到时会强调的.
