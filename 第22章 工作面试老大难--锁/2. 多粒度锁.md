# 2. 多粒度锁

前边提到的锁都是针对记录的,可以将这种针对记录的锁称为行级锁或行锁

- 事务对一条记录加锁,影响的也只是该条记录,称这个锁的粒度比较细
- 事务在表级别进行加锁,这种针对表的锁称为表级锁或表锁
  - **对一个表加锁会影响整个表中的记录**,称这个锁的粒度比较粗

给表加的锁也可以分为共享锁(S锁)和独占锁(X锁):

- 给表加S锁

    若一个事务给表加了S锁,则:
    
    - 其他事务可以继续获得该表的S锁
    - 其他事务可以继续获得该表中的某些记录的S锁
    - 其他事务不可以继续获得该表的X锁
    - 其他事务不可以继续获得该表中的某些记录的X锁

- 给表加X锁

    若一个事务给表加了X锁(表示该事务要独占该表),则:
    
    - 其他事务不可以继续获得该表的S锁
    - 其他事务不可以继续获得该表中的某些记录的S锁
    - 其他事务不可以继续获得该表的X锁
    - 其他事务不可以继续获得该表中的某些记录的X锁

为了更好地理解这个表级别的S锁和x锁,这里以大学教学楼中的教室为例来分析加锁的情况:(在以下例子中,`同学 = 事务`, `教室 = 记录`, `教学楼 = 表`)

- 教室一般都是公用的,同学可以随便选教室进去上自习

    当然,教室不是自家的,一间教室可以容纳很多同学同时上自习,每当一个同学进去上自习,就相当于在教室门口挂了一把S锁,若很多同学都进去上自习,则相当于教室门口挂了很多把S锁(类似行级别的S锁)

- 有时教室会进行检修,比方说换地板/换天花板/换灯管

    这些维修项目并不能同时开展.若教室针对某个项目进行检修,则不允许同学来上自习,也不允许其他维修项目进行,此时相当于教室门口挂了一把X锁(类似行级别的X锁)

以上2种锁都是针对教室而言的,有时候会有一些特殊的需求:

- 有上级领导要来参观教学楼的环境

    校领导并不想影响同学们上自习,但是此时不能有教室处于维修状态,所以可以在教学楼门口放置一把S锁(类似表级别的S锁).此时:
    
    - 来上自习的学生们看到教学楼门口有S锁,可以继续进入教学楼上自习
    - 修理工看到教学楼门口有S锁,则先在教学楼门口等着,等到上级领导走了,教学楼的S锁被撤掉了,才能进入教学楼维修

- 学校要占用教学楼进行考试

    此时不允许教学楼中有正在上自习的教室,也不允许对教室进行维修.所以可以在教学楼门口放置一把X锁(类似表级别的X锁).此时:
    
    - 来上自习的学生们看到教学楼门口有X锁,则先在教学楼门口等着,等到考试结束,教学楼的X锁被撤掉了,再进入教学楼上自习
    - 修理工看到教学楼门口有X锁,则先在教学楼门口等着,等到考试结束,教学楼的X锁被撤掉了,再进入教学楼维修

即:

- S锁相当于读锁,一个事务成功获取表级别读锁的前提: 该表没有被其他事务加了表级别的写锁(也可以说没有其他事务正在向该表写数据)
- X锁相当于写锁,一个事务成功获取表级别写锁的2个前提:
  - 该表没有被其他事务加了表级别的读锁(也可以说没有其他事务正在读取该表的数据)
  - 该表没有被其他事务加了表级别的写锁(也可以说没有其他事务正在向该表写数据)

但是这里有2个问题:

- 若想对教学楼整体上S锁,首先需要确保教学楼中没有正在维修的教室,若有正在维修的教室,则需要等到维修结束才可以对教学楼整体上S锁
  - 即上面总结的: 一个事务若想成功获取表级别读锁,需要确保该表没有被其他事务加了表级别的写锁
- 若想对教学楼整体上X锁,首先需要确保教学楼中:
  - 没有上自习的教室
  - 正在维修的教室
  - 若有上自习的教室或者正在维修的教室,则需要:
    - 等到全部上自习的同学都上完自习离开
    - 维修工维修完教室离开后
  - 才可以对教学楼整体上X锁
  - 即上面总结的: 一个事务若想成功获取表级别写锁,需要确保:
    - 该表没有被其他事务加了表级别的读锁
    - 该表没有被其他事务加了表级别的写锁

这时问题就来了: 在对教学楼整体上锁(表锁)时,如何确定教学楼中是否存在已经被上锁的教室(行锁)? 

依次检查每一间教室门口有没有上锁的策略太慢了(即: 遍历的方式太慢了).于是InnoDB的设计者们提出了一种称为意向锁(`Intention Locks`)的概念:

- 意向共享锁(`Intention Shared Lock`): 简称IS锁.当事务准备在某条记录上加S锁时,需要先在表级别加一个IS锁
- 意向独占锁(`Intention Exclusive Lock`): 简称IX锁.当事务准备在某条记录上加X锁时,需要先在表级别加一个IX锁

视角回到教学楼和教室上来:

- 若有学生到教室中上自习,则他先在整栋教学楼门口放一把IS锁(表级锁),然后再到教室门口放一把S锁(行锁)
- 若有维修工到教室中维修,则他先在整栋教学楼门口放一把IX锁(表级锁),然后再到教室门口放一把X锁(行锁)

之后:

- 若有上级领导要参观教学楼,即:想在教学楼门口前放S锁(表锁)时,首先要检查教学楼门口是否存在IX锁:
  - 若有,则表示有教室在维修,需要等到维修结束把IX锁撤掉后,才可以在整栋教学楼上加S锁
- 若有考试要占用教学楼,即: 想在教学楼门口前放X锁(表锁)时,首先要看一下教学楼门口是否存在IS锁或IX锁:
  - 若有,则表示有教室在上自习或者维修,需要等到:
    - 学生们上完自习结束把IS锁撤掉后
    - 维修结束把IX锁撤掉后
  - 才可以在整栋教学楼上加X锁

注:

- 学生在教学楼门口加IS锁时,是不关心教学楼门口是否有IX锁的
- 维修工在教学楼门口加IX锁时,是不关心教学楼门口是否有IS锁或者其他IX锁的
- IS和IX锁只是为了判断当前时间教学楼里有没有被占用的教室用的,即:
  - 在对教学楼加S锁时才会用到IS锁
  - 在对教学楼加X锁时才会用到IX锁

总结: **IS锁/IX锁是表级锁,它们的提出仅仅为了在之后加表级别的S锁和X锁时,可以快速判断表中的记录是否被上锁,以避免用遍历的方式来查看
表中是否存在上锁的记录**.即:

- **IS锁和IX锁是兼容的**
- **IX锁和IX锁是兼容的**

表级别锁的兼容性:

| 兼容性 |  X  | IX  |  S  | IS  |
|:---:|:---:|:---:|:---:|:---:|
|  X  | 不兼容 | 不兼容 | 不兼容 | 不兼容 |
| IX  | 不兼容 | 兼容  | 不兼容 | 兼容  |
|  S  | 不兼容 | 不兼容 | 兼容  | 兼容  |
| IS  | 不兼容 | 兼容  | 兼容  | 兼容  |
