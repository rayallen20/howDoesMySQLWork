# 7. 保存点

若已经开启了一个事务,且已经输入了很多语句,此时忽然发现前面已经执行完成的某个语句的参数写错了,只好使用`ROLLBACK`语句
让数据库状态恢复到事务执行之前的状态,然后再重新开始开启事务,编写该事务中的语句.

数据库的设计者提出了保存点(savepoint)的概念:在事务对应的数据库语句中"打"几个点,在调用`ROLLBACK`语句时可以指定回滚到哪个点,
而不是回到最初的原点.定义保存点的语法如下:

```
SAVEPOINT 保存点名称;
```

想回滚到某个保存点,使用如下语句(该语句中的单词`WORK`和`SAVEPOINT`是可以省略的):

```
ROLLBACK [WORK] TO [SAVEPOINT] 保存点名称;
```

若`ROLLBACK`语句后面不跟随保存点名称的话,会直接回滚到事务执行之前的状态.

想删除某个保存点,可以使用如下语句:

```
RELEASE SAVEPOINT 保存点名称;
```

以狗哥向猫爷转账10元的例子展示保存点的用法.在执行完扣除狗哥账户的钱10元的语句之后打一个保存点:

```
# 初始状态
mysql> SELECT * FROM account;
+----+--------+---------+
| id | name   | balance |
+----+--------+---------+
|  1 | 狗哥   |      11 |
|  2 | 猫爷   |       2 |
+----+--------+---------+
2 rows in set (0.00 sec)
```

```
# 开始事务
mysql> BEGIN;
Query OK, 0 rows affected (0.00 sec)

mysql> UPDATE account SET balance = balance - 10 WHERE id = 1;
Query OK, 1 row affected (0.01 sec)
Rows matched: 1  Changed: 1  Warnings: 0

# 定义一个名为 debit 的保存点
mysql> SAVEPOINT debit;
Query OK, 0 rows affected (0.00 sec)

# 此时事务处于未提交状态(就是还没写COMMIT语句)
mysql> SELECT * FROM account;
+----+--------+---------+
| id | name   | balance |
+----+--------+---------+
|  1 | 狗哥   |       1 |
|  2 | 猫爷   |       2 |
+----+--------+---------+
2 rows in set (0.00 sec)

# 更新语句的参数写错了(应该给猫爷的账户加10元,写成了加1元)
mysql> UPDATE account SET balance = balance + 1 WHERE id = 2;
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0

mysql> SELECT * FROM account;
+----+--------+---------+
| id | name   | balance |
+----+--------+---------+
|  1 | 狗哥   |       1 |
|  2 | 猫爷   |       3 |
+----+--------+---------+
2 rows in set (0.00 sec)

# 回滚到保存点debit处
mysql> ROLLBACK TO SAVEPOINT debit;
Query OK, 0 rows affected (0.00 sec)

mysql> SELECT * FROM account;
+----+--------+---------+
| id | name   | balance |
+----+--------+---------+
|  1 | 狗哥   |       1 |
|  2 | 猫爷   |       2 |
+----+--------+---------+
2 rows in set (0.00 sec)

# 重新执行更新语句
mysql> UPDATE account SET balance = balance + 10 WHERE id = 2;
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0

mysql> SELECT * FROM account;
+----+--------+---------+
| id | name   | balance |
+----+--------+---------+
|  1 | 狗哥   |       1 |
|  2 | 猫爷   |      12 |
+----+--------+---------+
2 rows in set (0.00 sec)

# 提交事务
mysql> COMMIT;
Query OK, 0 rows affected (0.00 sec)

# 查看结果
mysql> SELECT * FROM account;
+----+--------+---------+
| id | name   | balance |
+----+--------+---------+
|  1 | 狗哥   |       1 |
|  2 | 猫爷   |      12 |
+----+--------+---------+
2 rows in set (0.00 sec)
```
