# 3. Duplicate Weed-out(重复值消除)

对于下面这个查询:

```sql
SELECT *
FROM s1
WHERE key1 IN (
    SELECT common_field
    FROM s2
    WHERE key3 = 'a'
);
```

转换为半连接查询后,`s1`表中的某条记录可能在`s2`表中有多条匹配的记录,所以该条记录可能多次被添加到最后的结果集中.
为消除重复,可以建立一个临时表,例如:

```sql
CREATE TABLE tmp (
    id PRIMARY KEY
);
```

在执行连接查询的过程中,每当某条`s1`表中的记录要加入结果集时.就首先把这条记录的`id`值加入到这个临时表中:

- 若添加成功,则说明这条`s1`表中的记录在之前并没有加入最终的结果集,现在把该记录添加到最终的结果集
- 若添加失败,则说明这条`s1`表中的记录在之前就已经加入过最终的结果集,这里直接把它丢弃即可

这种**使用临时表消除`semi-join`结果集中的重复值的方式称之为`Duplicate Weed-out`(重复值消除)**.

注意: 重复值消除的执行策略,是不违背之前说的"半连接与物化互斥"的.重复值消除过程中产生的临时表,
本质上是一个去重缓存,类似哈希集合(Hash Set),而不是一张"可供扫描的表".因此重复值消除的执行策略并不违背"半连接与物化互斥"这一原则.
