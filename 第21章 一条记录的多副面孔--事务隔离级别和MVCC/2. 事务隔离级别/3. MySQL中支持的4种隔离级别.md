# 3. MySQL中支持的4种隔离级别

不同的数据库厂商对SQL标准中规定的4种隔离级别的支持不同.比如,Oracle就只支持`READ COMMITTED`和`SERIALIZABLE`隔离级别.本书讨论的MySQL虽然支持4种隔离级别,
但与SQL标准中规定的各级隔离级别允许发生的现象却有些出入:MySQL在`REPEATABLE READ`隔离级别下,可以很大程度上禁止幻读现象的发生(关于如何禁止会在后文详细说明).

MySQL的默认隔离级别为`REPEATABLE READ`.

若想让事务在不同的隔离级别中运行,可以通过以下语句修改事务的隔离级别:

```
SET [GLOBAL|SESSION] TRANSACTION ISOLATION LEVEL level;
```

其中,`level`有4个可选值:

- `READ UNCOMMITTED`: 读未提交
- `READ COMMITTED`: 读已提交
- `REPEATABLE READ`: 可重复读
- `SERIALIZABLE`: 串行化

在设置事务隔离级别的语句中,在`SET`关键字后面可以:

- 放置`GLOBAL`关键字
- 放置`SESSION`关键字
- 什么都不放

这样会对不同范围的事务产生不同的影响.

- 使用`GLOBAL`关键字(在全局范围产生影响)

    例如:
    
    ```
    SET GLOBAL TRANSACTION ISOLATION LEVEL SERIALIZABLE;
    ```
    
    则:
    
    - 只对执行完该语句之后新产生的会话起作用
    - 当前已经存在的会话无效

- 使用`SESSION`关键字(在会话范围产生影响)

    例如:

    ```
    SET SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE;
    ```
  
    则:
    
    - 对当前会话所有的后续事务有效
    - 该语句可以在已经开启的事务中执行,但不会影响当前正在执行的事务
    - 若在事务之间执行,则对后续的事务有效

- 上述两个关键字都不使用(只对执行`SET`语句后的下一个事务产生影响)

    例如:
    
    ```
    SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
    ```
    
    则:
    
    - 只对当前会话中下一个即将开启的事务有效
    - 下1个事务执行完后,后续事务将恢复到之前的隔离级别
    - 该语句不能在已经开启的事务中执行,否则会报错

若在服务器启动时想改变事务的默认隔离级别,可修改启动选项`transaction-isolation`的值.

例如:在启动服务器时指定了`--transaction-isolation=SERIALIZABLE`,则事务的默认隔离级别就从原来的`REPEATABLE READ`变成`SERIALIZABLE`.

可通过查看系统变量`transaction_isolation`的值来确定当前会话默认的隔离级别:

```
mysql> SHOW VARIABLES LIKE '%transaction_isolation%';
+-----------------------+-----------------+
| Variable_name         | Value           |
+-----------------------+-----------------+
| transaction_isolation | REPEATABLE-READ |
+-----------------------+-----------------+
1 row in set (0.07 sec)
```

或者使用更简便的写法:

```
mysql> SELECT @@transaction_isolation;
+-------------------------+
| @@transaction_isolation |
+-------------------------+
| REPEATABLE-READ         |
+-------------------------+
1 row in set (0.00 sec)
```

之前使用`SET TRANSACTION`语法来设置事务的隔离级别时,其实就是在间接设置系统变量`transaction-isolation`的值.也可以通过直接修改系统变量
`transaction-isolation`来设置事务的隔离级别.系统变量一般只有`GLOBAL`和`SESSION`这2个作用域,但`transaction-isolation`有3个:

- GLOBAL
- SESSION
- 仅作用于下1个事务

所以通过修改系统变量`transaction-isolation`的值来设置事务的隔离级别的语法比较特殊:

|                     语法                      | 作用范围  |
|:-------------------------------------------:|:-----:|
| `SET GLOBAL transaction_isolation = 某个隔离级别` |  全局   |
|      `SET @@GLOBAL.var_name = 某个隔离级别`       |  全局   |
|       `SET SESSION var_name = 某个隔离级别`       |  会话   |
|      `SET @@SESSION.var_name = 某个隔离级别`      |  会话   |
|           `SET var_name = 某个隔离级别`           | 下一个事务 |
|          `SET @@var_name = 某个隔离级别`          | 下一个事务 |

注:

`transaction-isolation`是在MySQL5.7.20的版本中引入的.用来替换`tx_isolation`.之前版本的MySQL则需要将前文提到的所有使用`transaction-isolation`的地方替换为`tx_isolation`.
