# 4. 幻读(`Phantom`)

幻读: 若一个事务先根据某些搜索条件査询出一些记录,在该事务未提交时,另一个事务写入了一些符合那些搜索条件的记录(这里的写入可以指
`INSERT`/`DELETE`/`UPDATE`操作),则表示发生了幻读现象.幻读现象简称为P3.

假设现在事务T1和事务T2并发执行,则P3对应的操作执行序列如下:

```
P3:r1[P]...w2[y in P]...((c1 or a1) and (c2 or a2) any order)
```

其中:

- `r1[P]`: 表示事务T1读取一些符合搜索条件`P`的记录
- `w2[y in P]`: 表示事务T2写入一些符合搜索条件`P`的记录
- `c1`: 表示事务T1的提交(commit)
- `a1`: 表示事务T1的中止(abort)
- `c2`: 表示事务T2的提交(commit)
- `a2`: 表示事务T2的中止(abort)
- `...`: 表示其他的一些操作

**幻读现象也可能引发一致性问题**.例如: 现在符合搜索条件P的记录条数有3条.该场景下,数据项z专门表示符合搜索条件`P`的记录条数,
数据项z的初始值当然也是3.

该场景下的一致性需求为: **让z表示符合搜索条件`P`的记录数**

现在并发执行事务T1和事务T2,它们的操作执行序列如下:

```
r1[P] -> w2[insert y to P] -> r2[z=3] -> w2[z=4] -> c2 -> r1[z=4] -> c1
```

- 事务T1读取符合搜索条件`P`的记录
- 事务T2插入了1条符合搜索条件`P`的记录
- 事务T2读取数据项z的值为3
- 事务T2更新数据项z的值为4
- 事务T2提交
- 事务T1读取数据项z的值为4
  - 这和事务T1之前实际读取出的符合搜索条件`P`的记录条数不符,不符合一致性需求
- 事务T1提交

最终事务T1读取到符合搜索条件`P`的记录数量为3条,但读取到的数据项z的值为4.很显然这是一个不一致的状态.**数据库的不一致状态是不应该暴露给用户的**.

P3描述的事务的操作执行序列,是幻读的广义解释.针对幻读还有一种严格解释.为与广义解释进行区分,将幻读的严格解释称为A3.A3对应的操作执行序列如下:

```
A3: r1[P]...w2[y in P]...c2...r1[P]...c1
```

即:

- 事务T1读取符合搜索条件`P`的记录
- 事务T2写入符合搜索条件`P`的记录
- 事务T2提交
- 事务T1再次读取符合搜索条件`P`的记录
  - 此时会发现2次读取的记录是不同的
- 事务T1提交

注:

由于SQL标准中,对并发事务执行过程中可能产生一致性问题的各种现象描述不清晰,所以此处采用了论文`A Critique of ANSI SQL Isolation Levels`中
关于:

- 脏写
- 脏读
- 不可重复读
- 幻读

的定义.

另外,SQL标准中针对幻读的描述,只认为当事务T2插入符合搜索条件`P`的记录时,才会引起幻读现象.而论文论文`A Critique of ANSI SQL 
Isolation Levels`中,强调了事务T2进行:

- `INSERT`
- `DELETE`
- `UPDATE`

操作时均可引起幻读现象.

注意: 以上关于:

- 脏写
- 脏读
- 不可重复读
- 幻读

的讨论均属于理论范畴,不涉及具体数据库.对于MySQL而言,幻读强调的是: 一个事务在按照某个相同的搜索条件多次读取记录时,
在后读取时读到了之前没有读到的记录.这里说的"后读取到的之前没有读到的记录":

- 可能是由别的事务执行`INSERT`语句插入的
- 也可能是别的事务执行`UPDATE`语句插入的

**这些之前读取时不存在的记录也被称为幻影记录**.假设:

- 事务T1根据搜索条件`P`读取了一些记录
- 事务T2删除了一些符合搜索条件`P`的记录
- 事务T2提交

此时,若事务T1再读取符合相同搜索条件`P`的记录时,读取到了不同的结果集,就可以把这种现象认为是:**结果集中的每一条记录都发生了不可重复读现象**.
