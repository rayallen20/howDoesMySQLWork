# 4. MVCC小结

MVCC: 指的就是在

- `READ COMMITED`
- `REPEATABLE READ`

这2种隔离级别下的事务,在执行普通的SELECT操作时,访问记录的版本链的过程.这样可以使不同事务的:

- 读-写
- 写-读

操作并发执行.

`READ COMMITED`/`REPEATABLE READ`这2个隔离级别有一个很大的不同:生成`ReadView`的时机不同

- `READ COMMITED`: 在每一次进行普通SELECT操作前都会生成一个`ReadView`
- `REPEATABLE READ`: 只在第一次进行普通SELECT操作前生成一个`ReadView`,之后的査询操作都重复使用该`ReadView`

注:

在讲`undo`日志时曾经讲到过:在执行DELETE语句或者更新主键值的UPDATE语句时,并不会立即把对应的记录(包括聚簇索引记录和二级索引记录)完全从页面中
删除,而是执行一个`delete mark`操作,这相当于只是给记录打上一个删除标记位.这个`delete mark`操作主要就是为MVCC服务的.

比如: 事务T1和事务T2并发执行,事务T1的隔离级别为`REPEATABLE READ`.

- 事务T1根据某些搜索条件读取到一条记录
- 然后事务T2将其删除
- 然后事务T1又根据同样的搜索条件读取记录

若事务T2执行的删除操作是将该记录彻底删除,则事务T1就再也读不到该记录了.所以事务T2只是执行一个`delete mark`操作,在记录的头信息中打一个删除标记而已.

另外,只有进行普通的SELECT查询时,MVCC才生效.截至目前,所见的所有SELECT 语句都算是普通的査询.不普通的査询在下一章会讲到.
