# 3. 二级索引与MVCC

只有在聚簇索引记录中才有`trx_id`和`roll_pointer`隐藏列.若某个査询语句使用二级索引来执行查询,该如何判断可见性? 比如下面这个事务:

```sql
BEGIN;
SELECT name FROM hero WHERE name = '刘备';
```

假设查询优化器决定先到二级索引`idx_name`中定位`name`值为`'刘备'`的二级索引记录,那么如何确定这条二级索引记录对该査询事务是否可见?
判断可见性的过程大致分为以下2步:

- 步骤1

    二级索引页面的`Page Header`部分有一个名为[`PAGE_MAX_TRX_ID`](https://github.com/rayallen20/howDoesMySQLWork/blob/main/%E7%AC%AC5%E7%AB%A0%20%E7%9B%9B%E6%94%BE%E8%AE%B0%E5%BD%95%E7%9A%84%E5%A4%A7%E7%9B%92%E5%AD%90--InnoDB%E6%95%B0%E6%8D%AE%E9%A1%B5%E7%BB%93%E6%9E%84/5.%20Page%20Header(%E9%A1%B5%E9%9D%A2%E5%A4%B4%E9%83%A8).md)的属性,每当对该页面中的记录执行增删改操作时:
    
    - 若`执行该操作的事务的事务id > 二级索引页面的PAGE_MAX_TRX_ID`,则把该页面的`PAGE_MAX_TRX_ID`属性设置为执行该操作的事务的事务id
    
    这也就意味着`PAGE_MAX_TRX_ID`属性值表示修改该二级索引页面的最大事务id是多少.
    
    当SELECT语句访间某个二级索引记录时,首先检查: `事务的ReadView.min_trx_id > 该二级索引页面的PAGE_MAX_TRX_ID`是否成立
    
    - 若成立,说明该二级索引页面中的所有记录都对该ReadView可见
    - 否则就得执行步骤2,在回表后才能判断可见性

- 步骤2

    利用二级索引记录中的主键值进行回表操作,得到对应的聚索引记录后,再按照[前面讲过的方式](https://github.com/rayallen20/howDoesMySQLWork/blob/main/%E7%AC%AC21%E7%AB%A0%20%E4%B8%80%E6%9D%A1%E8%AE%B0%E5%BD%95%E7%9A%84%E5%A4%9A%E5%89%AF%E9%9D%A2%E5%AD%94--%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E5%92%8CMVCC/3.%20MVCC%E5%8E%9F%E7%90%86/2.%20ReadView/0.%20%E6%A6%82%E8%BF%B0.md)找到对该`ReadView`可见的第一个版本,然后判断该版本中
    相应的二级索引列的值是否与利用该二级索引查询时的值相同
    
    本例中就是判断找到的第一个可见版本的`name`值是否为`'刘备’`:
    
    - 若是,则把该条记录发送给客户端
      - 若`WHERE`子句中还有其他搜索条件的话还需继续判断
    - 否则就跳过该记录
